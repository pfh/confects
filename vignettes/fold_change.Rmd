---
title: "Confident fold change"
author: "Paul Harrison"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Confident fold change}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
params:
    cache: !r FALSE
---

<!--
devtools::load_all(".") ; rmarkdown::render("vignettes/fold_change.Rmd", intermediates_dir="/tmp", output_dir="/tmp", clean=FALSE, params=list(cache=TRUE))
-->

<style>
.contents h2 { margin-top: 2em }
</style>

This document shows typical Topconfects usage.

The first step is to load a dataset. Here, we're looking at RNA-seq data that investigates the response of *Arabodopsis thaliana* to a bacterial pathogen. Besides the experimental and control conditions, there is also a batch effect. This dataset is also examined in section 4.2 of the `edgeR` user manual, and I've followed the initial filtering steps in the `edgeR` manual.

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=6)
if (params$cache)
    knitr::opts_chunk$set(cache=TRUE, autodep=TRUE, cache.path="/tmp/fold_change_cache")
```


```{r load, message=FALSE, warning=FALSE}
library(topconfectsql)

library(NBPSeq)
library(edgeR)
library(limma)

library(dplyr)
library(ggplot2)

data(arab)

# Retrieve symbol and description for each gene
info <- 
    AnnotationDbi::select(
        org.At.tair.db::org.At.tair.db, 
        rownames(arab), c("SYMBOL","GENENAME")) %>%
    group_by(TAIR) %>% 
    summarize(
        SYMBOL=paste(unique(na.omit(SYMBOL)),collapse="/"), 
        GENENAME=paste(unique(na.omit(GENENAME)),collapse="/"))
arab_info <- 
    info[match(rownames(arab),info$TAIR),] %>% 
    select(-TAIR) %>%
    as.data.frame
rownames(arab_info) <- rownames(arab)

# Extract experimental design from sample names
Treat <- factor(substring(colnames(arab),1,4)) %>% relevel(ref="mock")
Time <- factor(substring(colnames(arab),5,5))

y <- DGEList(arab, genes=as.data.frame(arab_info))

# Keep genes with at least 3 samples having an RPM of more than 2
keep <- rowSums(cpm(y)>2) >= 3
y <- y[keep,,keep.lib.sizes=FALSE]
y <- calcNormFactors(y)
```


## limma analysis

### Standard limma analysis steps

```{r limma}
design <- model.matrix(~Time+Treat)
design[,]

fit <-
    voom(y, design) %>%
    lmFit(design)
```

### Apply topconfects

Find largest fold changes that we can be confident of at FDR 0.05.

```{r limma_confects}
confects <- limma_confects(fit, coef=4, fdr=0.05)

confects
```


### Looking at the result

Here the usual `logFC` values estimated by `limma` are shown as dots, with lines to the `confect` value.

```{r fig.height=7}
confects_plot(confects)
```

`confects_plot_me` overlays the confects (black) on a Mean-Difference Plot (grey) (as might be produced by `limma::plotMD`). As we should expect, the very noisy differences with low mean expression are removed if we look at the confects.

```{r}
confects_plot_me(confects)
```

Let's compare this to the ranking we obtain from `topTable`.

```{r, fig.height=7}
fit_eb <- eBayes(fit)
top <- topTable(fit_eb, coef=4, n=Inf)

rank_rank_plot(confects$table$name, rownames(top), "limma_confects", "topTable")
```

You can see that the top 19 genes from topTable are all within the top 40 for topconfects ranking, but topconfects has also highly ranked some other genes. These have a large effect size, and sufficient if not overwhelming evidence of this.

An MD-plot highlighting the positions of the top 40 genes in both rankings also illustrates the differences between these two ways of ranking genes.

```{r}
plotMD(fit, legend="bottomleft", status=paste0(
    ifelse(rownames(fit) %in% rownames(top)[1:40], "topTable ",""),
    ifelse(rownames(fit) %in% confects$table$name[1:40], "confects ","")))
```


## edgeR analysis

An analysis in edgeR produces similar results.

### Standard edgeR analysis

```{r edger}
y <- estimateDisp(y, design, robust=TRUE)
efit <- glmQLFit(y, design, robust=TRUE)
```

### Apply topconfects

```{r edger_confects}
econfects <- edger_confects(efit, coef=4, fdr=0.05)

econfects
```


### Looking at the result

```{r fig.height=7}
confects_plot(econfects)
```

```{r}
etop <-
    glmQLFTest(efit, coef=4) %>%
    topTags(n=Inf)

plotMD(efit, legend="bottomleft", status=paste0(
    ifelse(rownames(efit) %in% econfects$table$name[1:40], "confects ", ""),
    ifelse(rownames(efit) %in% rownames(etop)[1:40], "topTags ","")))
```

### Comparing limma and edgeR results

```{r fig.height=7}
rank_rank_plot(confects$table$name, econfects$table$name, "limma confects", "edgeR confects")
```

---

```{r}
sessionInfo()
```


