---
title: "Nonlinear interaction effects"
author: "Paul Harrison"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
    %\VignetteIndexEntry{Confident fold change}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
params:
    cache: !r FALSE
---

<!--
devtools::load_all(".") ; rmarkdown::render("vignettes/nonlinear_effect.Rmd", intermediates_dir="/tmp", output_dir="/tmp", clean=FALSE, params=list(cache=TRUE))
-->

<style>
.contents h2 { margin-top: 2em }
</style>

To illustrate non-linear interaction effects, we will be working with the GEO dataset [GSE80512](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE80512). Briefly, this examines the effect of stressing yeast with heat or high salt concentration, with wildtype yeast and a yeast with a mutated histone in which post-translational phosphorylation at a certain site is prevented (thought to affect gene regulation). This data set was chosen simply because it is a good quality, publicly available data set which can be used to illustrate the interaction of two experimental factors.

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width=7, fig.height=6)
if (params$cache)
    knitr::opts_chunk$set(cache=TRUE, autodep=TRUE, cache.path="/tmp/nonlinear_effect_cache/")
```

```{r load, message=FALSE, warning=FALSE}
library(topconfectsql)

library(reshape2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)

library(edgeR)

counts <- 
    read.delim("GSE80512_DESeq2_raw_counts.txt.gz", row.names=1) %>% 
    as.matrix

# Retrieve symbol and description for each gene
info <- AnnotationDbi::select(
    org.Sc.sgd.db::org.Sc.sgd.db, 
    rownames(counts), c("GENENAME")) 
all(rownames(counts) == info$ORF)
info <- select(info, GENENAME) %>% as.data.frame
rownames(info) <- rownames(counts)

# Experiment design
samples <- read_csv(
   "strain,stress,sample
    wt,none,Sample_1_13462_CGATGT
    wt,none,Sample_2_13463_TTAGGC
    wt,none,Sample_3_13464_GATCAG
    mutant,none,Sample_4_13465_CCGTCC
    mutant,none,Sample_5_13466_GTCCGC
    mutant,none,Sample_6_13467_ATTCCT
    wt,salt,Sample_7_13468_ATCACG
    wt,salt,Sample_8_13469_GCCAAT
    wt,salt,Sample_9_13470_ACTTGA
    mutant,salt,Sample_10_13471_TAGCTT
    mutant,salt,Sample_11_13472_GGCTAC
    mutant,salt,Sample_12_13473_ATGTCA
    wt,heat,Sample_13_13474_TGACCA
    wt,heat,Sample_14_13475_ACAGTG
    wt,heat,Sample_15_13476_CAGATC
    mutant,heat,Sample_16_13477_GTGGCC
    mutant,heat,Sample_17_13478_CGTACG
    mutant,heat,Sample_18_13479_GAGTGG") %>%
    mutate(
        strain=factor(strain,unique(strain)),
        stress=factor(stress,unique(stress)))
all(samples$sample == colnames(counts))
```

## edgeR fit

```{r edger}
design <- model.matrix(~ 0 + strain:stress, data=samples)
colnames(design)

y <- DGEList(counts, genes=info)
keep <- rowSums(cpm(y)>2) >= 3
table(keep)
y <- y[keep, , keep.lib.sizes=FALSE]
y <- calcNormFactors(y) %>%
    estimateDisp(design)

fit <- glmQLFit(y, design)

fit$df.prior
```

## Viewing stamp collections

With two possible main effects and an interaction effect, it will be important to view the raw data to understand what is actually going on.

```{r stamp}
group_rpms <- 
    (exp(fit$coefficients) * 1e6) %>%
    melt(c("gene","coef"), value.name="RPM") %>% 
    separate(coef, c("strain","stress")) %>%
    mutate(strain = factor(gsub("strain","",strain), levels=c("wt","mutant")),
           stress = factor(gsub("stress","",stress), levels=c("none","salt","heat")))

sample_rpms <- 
    cpm(y) %>%
    melt(c("gene","sample"), value.name="RPM") %>%
    left_join(samples,"sample")

show_stamps <- function(names, stressors, n=25) {
    names <- head(names, n)
    
    group_rpms %>% 
    filter(gene %in% names, stress %in% stressors) %>% 
    mutate(gene=factor(gene,names)) %>%
    ggplot(aes(x=stress,color=strain,group=strain,y=RPM)) + 
    geom_line() +
    geom_point(
        data=filter(sample_rpms, gene %in% names, stress %in% stressors), 
        alpha=0.333, size=3, stroke=0) +
    geom_hline(yintercept=0) + 
    facet_wrap(~ gene, scales="free_y")
}
```

First, let us look at a random sample of genes. Let's just concentrate on the response to salt for now.

```{r}
show_stamps(sample(rownames(y)), c("none", "salt"))
```

Many of the genes show differential expression due to the salt stress. However our primary interest is how this interacts with the histone mutation.

## edgeR topTags

Let's try to identify genes where the response to salt stress is different in the mutant.

This contrast on the log-linear model will search for genes where 

> `(mutant_salt/mutant_none)/(wt_salt/wt_none) != 1`

```{r edger_test}
top <- fit %>%
    glmQLFTest(contrast=c(1,-1,-1,1,0,0)) %>%
    topTags(n=Inf)

table(top$table$FDR <= 0.05)

print(head(top$table, 10), right=FALSE)
```

We have significance to spare, but:

```{r edger_show}
show_stamps(rownames(top$table), c("none", "salt"))
```

The top results by p-value are rather hit-and-miss in terms of a substantial interaction effect.

Note: Taking a leaf out of [Di Cook's](http://dicook.github.io/) playbook, with 520 significant results it would not take long to manually examine all of them. This would only require examining 21 figures such as the one shown above.


## Linear confects

We now instead will search for genes where 

> `log2( (mutant_salt/mutant_none)/(wt_salt/wt_none) )` has maximum magnitude.

```{r linear}
linear <- edger_confects(fit, contrast=c(1,-1,-1,1,0,0))

linear
```

```{r linear_show}
confects_plot(linear)
```

```{r linear_stamps}
show_stamps(linear$table$name, c("none", "salt"))
```

This is no great improvement. Can you see the problem? A difference in ratios between when the gene is essentially off and when it is on is not interesting. The fact of the gene turning on is the story -- but not the story we are interested in!


## Non-linear confects

Let us now seek out genes where

> `salt_mutant/(none_mutant+salt_mutant) - salt_wt/(none_wt+salt_wt)` 
> has maximum magnitude.
>
> The response to salt in the mutant, compared to the wildtype.

That is, a "difference of proportions".

<!--
> `(salt_mutant*none_wt-none_mutant*salt_wt)/(salt_mutant*none_wt+none_mutant*salt_wt)`
> has maximum magnitude.

This is Yule's Q or Kruskall and Wallace's gamma, treating our data as a contingency table. However in testing its significance we will still be using the negative binomial noise distribution.
-->

```{r nonlinear}
# This creates an object specifying the non-linear effect we are interested in.
# topconfects has several such effect_... functions, and more can easily be added.
# The _log2 is because edgeR has a log link function,
#    and coefficients need to be transformed back to a linear scale.
effect <- effect_shift_log2(c(1,3),c(2,4))

nonlinear <- edger_confects(fit, effect=effect)

nonlinear
```

```{r nonlinear_show}
confects_plot(nonlinear)
```

```{r nonlinear_stamps}
show_stamps(nonlinear$table$name, c("none", "salt"))
```

Look at all these wonderful interactions that were hiding in the data!


## Appendix: Lack of symmetry

The non-linear effect size we examined is not symmetric in the two experimental factors. We might instead seek genes where

> `salt_mutant/(salt_wt+salt_mutant) - none_mutant/(none_wt+none_mutant)` 
> has maximum magnitude.
>
> The response to the mutation in salt, compared to neutral conditions.

```{r nonlinear2}
effect2 <- effect_shift_log2(c(1,2),c(3,4))
nonlinear2 <- edger_confects(fit, effect=effect2)
show_stamps(nonlinear2$table$name, c("none", "salt"))
```

The top ranked genes are different. Here they are not as interesting.

---

```{r}
sessionInfo()
```




